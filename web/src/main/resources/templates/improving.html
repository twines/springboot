<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <title>完善资料</title>
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../../layuiadmin/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/admin.css" media="all">
    <link rel="stylesheet" href="../../layuiadmin/style/login.css" media="all">
</head>
<body>
<div class="layui-container">
    <div>
        <label>暂未认证企业</label>
    </div>
    <hr>
    <!--    说明-->
    <div id="user-tips" class="layui-row">
        <div class="layui-row">

            <label>企业认证所需资料
                <span>为保证认证顺利，请提前准备好以下资料</span>
            </label>
        </div>
        <div class="layui-row">
            <span>附件仅支持 JPG、JPEG、PNG、PDF 四种格式，单个文件大小不超过5.0 MB</span>
        </div>

        <div>
            <div>
                <h1>一、企业证件</h1>
                <h2>中国大陆：营业执照(三证合一无需准备其他企业证件)、组织机构代码证、税务登记证
                </h2>
                <div class="layui-row">
                    <button class="layui-btn"><a href="#"> 三证合一样图</a></button>
                    <button class="layui-btn"><a href="#"> 营业执照样图</a></button>
                    <button class="layui-btn"><a href="#"> 组织机构代码证样图</a></button>
                    <button class="layui-btn"><a href="#"> 税务登记证样图</a></button>
                </div>
            </div>
            <br>
            <div>
                <h1>二、重要组成人员身份证明文件</h1>
                <h2>法定代表人、企业董事、实际控股人和持股10%及以上的股东身份证正面持照照片、反面证件照片；</h2>
                <div class="layui-row">
                    <button class="layui-btn"><a href="#"> 身份证证正面样图</a></button>
                    <button class="layui-btn"><a href="#"> 身份证反面样图</a></button>
                </div>
            </div>
            <br>
            <div>
                <h1>三、第三方证明文件</h1>
                <h2>若您是被授权人，请填写授权书(点击下载)，加盖公司公章(个体工商户可按法人代表手印)</h2>
                <div class="layui-row">
                    <button  class="layui-btn"><a href="#"> 授权书样图</a></button>
                </div>
            </div>
            <br>
            <div>
                <h1>四、开户申请表</h1>
                <h2>请填写开户申请表(点击下载)后加盖公司公章(个体工商户可按法人代表手印)</h2>
                <div class="layui-row">
                    <button  class="layui-btn"><a href="#"> 开户申请表样图</a></button>
                </div>
            </div>
        </div>
        <b
        <br>
        <div class="layui-row">
            <button id="start-confirm" class="layui-btn">我已阅读上述说明，开始认证</button>
        </div>

    </div>
    <!--    填写过程-->
    <div id="user-input"  class="layui-hide layui-form layui-col-md10 layui-col-sm6">
        <div class="layui-form-item">
            <label class="layui-form-label">统一社会信用代码</label>

            <div class="layui-input-block">
                <input lay-verify="required|code" id="code-input" name="code" type="text" placeholder="请手动输入统一社会信用代码"
                       autocomplete="off"
                       class="layui-input">
                <input id="code-tmp" hidden>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-row">
                <label class="layui-form-label">法人姓名</label>
                <div class="layui-input-block ">
                    <input class="layui-input" id="code-name-tmp" placeholder="法人姓名（上传执照识别）" disabled>
                </div>
            </div>
        </div>

        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input class="layui-input" lay-verify="required|name" id="name-input" name="name" type="text"
                       placeholder="推荐上传身份证件自动识别"
                       autocomplete="off">
                <input id="name-tmp" hidden>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">法人身份证号</label>
            <div class="layui-input-block">
                <input class="layui-input" id="id-input" name="id" type="text"
                       placeholder="推荐上传身份证件自动识别"
                       disabled
                       autocomplete="off">
                <input id="id-tmp" hidden>
            </div>
        </div>

        <div class="layui-form-item layui-row">
            <label class="layui-form-label">添加企业营业执照</label>
            <div class="layui-input-inline">
                <button type="button" class="layui-btn" id="codePart">
                    <i class="layui-icon">&#xe67c;</i>上传营业执照
                </button>
                <input lay-verify="required|codePart" id="code-part" name="code-part" type="text" hidden>
            </div>
            <button class="layui-btn"><a class="layui-inline" href="/upload/758/54b92a35-6346-4ff0-ac4e-54dfdcc72745.jpg">企业营业执照样张</a>
            </button>

        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">添加法人身份证</label>
            <div class="layui-input-inline">
                <div class="layui-row">
                    <button type="button" class="layui-btn" id="namePart">
                        <i class="layui-icon">&#xe67c;</i>上传法人身份证
                    </button>
                </div>


                <input lay-verify="required|namePart" id="name-part" name="name-part" type="text" hidden>
            </div>
            <button class="layui-btn"><a class="layui-inline" href="/upload/758/54b92a35-6346-4ff0-ac4e-54dfdcc72745.jpg">身份证样张</a>
            </button>

        </div>

        <button class="layui-btn" lay-submit lay-filter="impovData">提交</button>

    </div>

</div>

<script src="/layuiadmin/layui/layui.js"></script>
<script>
    function startConfirm($) {
        $(document).on('click','#start-confirm',function(){
            // layer.msg('hello');
            $("#user-input").removeClass("layui-hide");
            $("#user-tips").addClass("layui-hide");
        });
    }
    layui.config({
        base: '/layuiadmin/' //静态资源所在路径
    }).extend({
        index: 'lib/index' //主入口模块
    }).use(['index', 'user', 'upload', 'jquery', 'form'], function () {

        var $ = layui.$
            , setter = layui.setter
            , admin = layui.admin
            , form = layui.form
            , upload = layui.upload
            , router = layui.router()
            , search = router.search;
        startConfirm($);

        var codePart = upload.render({
            elem: '#codePart' //绑定元素
            , url: '/user/upload/' //上传接口
            , before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                layer.load(); //上传loading
            }
            , done: function (res) {
                layer.closeAll('loading'); //关闭loading

                layer.msg(res.msg);
                $("#code-part").attr("value", res.data.url);
                var regValue = res.data.ocr.match(/统一社会信用代码+[0-9a-zA-Z]+/);
                console.log(regValue);
                if (regValue == null || regValue.length == 0) {
                    layer.msg("无法识别营业执照中社会信用代码请重新上传");
                    return;
                }
                var codeValue = regValue[0].replace("统一社会信用代码", "");
                regValue = res.data.ocr.match(/法定代表人[^\x00-\xff]{2,4}/);
                if (regValue == null || regValue.length == 0) {
                    layer.msg("无法识别营业执照中的法人姓名请重新上传");
                    return;
                }
                var nameValue = regValue[0].replace("法定代表人", "")
                    .replace(",C", "");
                $('#code-tmp').attr("value", codeValue);
                $('#code-input').attr("value", codeValue);
                $('#code-name-tmp').attr("value", nameValue);
                console.log(res.data.ocr);
            }
            , error: function () {
                //请求异常回调
                layer.closeAll('loading'); //关闭loading

            }
        });

        var namePart = upload.render({
            elem: '#namePart' //绑定元素
            , url: '/user/upload/' //上传接口
            , before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致，可参见上文。
                layer.load(); //上传loading
            }
            , done: function (res) {
                layer.closeAll('loading'); //关闭loading

                //上传完毕回调
                layer.msg(res.msg);
                $('#name-part').attr("value", res.data.url);
                var regValue = res.data.ocr.match(/名[^\\x00-\\xff]{2,4}/);
                if (regValue == null || regValue.length == 0) {
                    layer.msg("无法识别法人身份证姓名请重新上传");
                    return;
                }
                var nameValue = regValue[0].replace("名", "");
                var idValue = res.data.ocr.match(/\d{6}(\d{4})(\d{2})(\d{2})(\d{3})([0-9]|X)/)[0].replace("名", "");
                $('#name-tmp').attr("value", nameValue);
                $('#name-input').attr("value", nameValue);

                $('#id-input').attr("value", idValue);


                console.log(regValue);
                console.log(idValue);
                console.log(res.data.ocr);
            }
            , error: function () {
                //请求异常回调
                layer.closeAll('loading'); //关闭loading
            }
        });


        form.render();
        form.verify({
            codePart: function (value, item) {
                console.log(value);
                if (value.length == 0) {
                    return "请添加企业营业执照";
                }
                // if (value.length != 18) {
                //     return "请输入正确的统一社会信用代码";
                // }
            },
            namePart: function (value, item) {
                if (value.length == 0) {
                    return "请添加法人身份证";
                }

            },
            name: function (value, item) {
                if (value.length < 2 || value.length > 4) {
                    return "请输入正确的法人姓名";
                }
            },
            code: function (value, item) {
                var result = value.match(/[0-9a-zA-Z]{17,20}/)[0];
                console.log(value);
                console.log(result);
                if (result === undefined) {
                    return '请输入正确的统一社会信用代码';

                }


            }
        });
        //提交
        form.on('submit(impovData)', function (obj) {

            //输入的代码
            var codeInput = $("#code-input").val();
            //ocr识别的代码
            var codeOcr = $('#code-tmp').val();


            //执照识别出的法人
            var codeName = $('#code-name-tmp').val();

            //输入的名字
            var nameInput = $("#name-input").val();

//识别的名字
            var nameOcr = $('#name-tmp').val();

            // console.log(codeOcr);
            // console.log(codeInput);
            // console.log(nameInput);
            // console.log(codeName);

            if (codeOcr !== codeInput) {

                layer.msg("请检查统一社会信用代码");

                return;
            }


            // if (nameInput !== nameOcr) {
            //     layer.msg("请核对法人姓名");
            //     layer.closeAll('loading'); //关闭loading
            //
            //     return;
            // }
            // if (nameOcr !== codeName) {
            //     layer.msg("法人身份与营业执照不符合");
            //     layer.closeAll('loading'); //关闭loading
            //
            //     return;
            // }

            if (codeName !== nameInput || nameInput !== nameOcr) {
                var msg = "法人姓名与身份证识别输入不一致";
                layer.msg(msg);
                return;
            }
            layer.load(); //上传loading

            admin.req({
                url: '/user/doImpov',
                method: 'POST',
                data: obj.field,

                done: function (res) {
                    layer.closeAll('loading'); //关闭loading


                }
            });
            return false;
        });


    });
</script>
</body>
</html>